<!DOCTYPE html>
<html>
<head>
    <title>Parchment Interactive Demo</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .demo-section { 
            margin: 25px 0; 
            padding: 20px; 
            border: 2px solid #e9ecef; 
            border-radius: 10px; 
            background: #f8f9fa;
        }
        .input-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        textarea:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
        }
        button { 
            padding: 12px 20px; 
            margin: 5px; 
            cursor: pointer; 
            border: none;
            border-radius: 6px;
            background: #007acc;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
        }
        button:hover {
            background: #005a9e;
            transform: translateY(-1px);
        }
        .results {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #007acc;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #007acc;
            display: block;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            margin-top: 5px;
        }
        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }
        .replace-input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        .emoji {
            font-size: 1.2em;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="emoji">üöÄ</span>Parchment Interactive Demo</h1>
        <p>Experience the advanced text operations powered by Rust and WebAssembly!</p>

        <!-- Text Statistics Demo -->
        <div class="demo-section">
            <h2><span class="emoji">üìä</span>Live Text Statistics</h2>
            <div class="input-section">
                <label for="stats-text"><strong>Enter your text:</strong></label>
                <textarea id="stats-text" placeholder="Type or paste your text here to see live statistics...">The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet at least once. It's commonly used for testing fonts and keyboards!</textarea>
                <button onclick="updateStatistics()">üìä Calculate Statistics</button>
            </div>
            
            <div class="stats-grid" id="stats-display">
                <!-- Stats will be populated here -->
            </div>
            
            <div id="stats-details" class="results">
                <!-- Detailed stats will appear here -->
            </div>
        </div>

        <!-- Find and Replace Demo -->
        <div class="demo-section">
            <h2><span class="emoji">üîç</span>Find & Replace Operations</h2>
            <div class="input-section">
                <label for="search-text"><strong>Text to search in:</strong></label>
                <textarea id="search-text" placeholder="Enter text to search...">The quick brown fox jumps over the lazy dog. The fox is very quick and the dog is quite lazy. Every fox knows that dogs can be lazy.</textarea>
                
                <div class="search-controls">
                    <input type="text" id="find-term" class="search-input" placeholder="Find..." value="fox">
                    <input type="text" id="replace-term" class="replace-input" placeholder="Replace with..." value="cat">
                    <button onclick="findText()">üîç Find</button>
                    <button onclick="replaceText()">üîÑ Replace All</button>
                </div>
            </div>
            
            <div id="search-results" class="results">
                <!-- Search results will appear here -->
            </div>
        </div>

        <!-- Test Runner -->
        <div class="demo-section">
            <h2><span class="emoji">üß™</span>Run WASM Tests</h2>
            <p>Execute the built-in test suite to verify all functionality:</p>
            <button onclick="runQuickTests()">üöÄ Run Quick Tests</button>
            <button onclick="window.open('test-visual.html', '_blank')">üìã Open Full Test Suite</button>
            
            <div id="test-results" class="results" style="display: none;">
                <!-- Test results will appear here -->
            </div>
        </div>
    </div>

    <script type="module">
        import init, {
            ScrollBlot,
            test_selection_management,
            test_find_replace,
            test_text_statistics,
            test_advanced_text_operations,
        } from "../pkg/quillai_parchment.js";

        let wasm;

        // Define all functions first
        window.updateStatistics = function() {
            const text = document.getElementById('stats-text').value;
            const statsDisplay = document.getElementById('stats-display');
            const statsDetails = document.getElementById('stats-details');
            
            try {
                // Create a ScrollBlot and calculate statistics
                const scrollBlot = new ScrollBlot(null);
                scrollBlot.append_text(text);
                
                const wordCount = scrollBlot.word_count();
                const charCount = scrollBlot.character_count(true);
                const charCountNoSpaces = scrollBlot.character_count(false);
                const paragraphCount = scrollBlot.paragraph_count();
                const stats = scrollBlot.get_statistics();
                
                // Update stats grid
                statsDisplay.innerHTML = `
                    <div class="stat-card">
                        <span class="stat-number">${wordCount}</span>
                        <div class="stat-label">Words</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${charCount}</span>
                        <div class="stat-label">Characters</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${charCountNoSpaces}</span>
                        <div class="stat-label">No Spaces</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${paragraphCount}</span>
                        <div class="stat-label">Paragraphs</div>
                    </div>
                `;
                
                // Update detailed stats
                statsDetails.innerHTML = `
                    <strong>üìä Detailed Statistics:</strong><br>
                    ‚Ä¢ Text length: ${text.length} characters<br>
                    ‚Ä¢ Words: ${stats.words} (Unicode-aware counting)<br>
                    ‚Ä¢ Characters (with spaces): ${stats.characters}<br>
                    ‚Ä¢ Characters (without spaces): ${stats.characters_no_spaces}<br>
                    ‚Ä¢ Paragraphs: ${stats.paragraphs}<br>
                    ‚Ä¢ Average words per paragraph: ${(stats.words / Math.max(stats.paragraphs, 1)).toFixed(1)}
                `;
                
            } catch (error) {
                statsDetails.innerHTML = `<div class="error">Error calculating statistics: ${error.message}</div>`;
            }
        };

        window.findText = function() {
            const text = document.getElementById('search-text').value;
            const findTerm = document.getElementById('find-term').value;
            const resultsDiv = document.getElementById('search-results');
            
            if (!findTerm.trim()) {
                resultsDiv.innerHTML = '<div class="error">Please enter a search term</div>';
                return;
            }
            
            try {
                const scrollBlot = new ScrollBlot(null);
                scrollBlot.append_text(text);
                
                const matches = scrollBlot.find_text(findTerm, false);
                
                if (matches && matches.length > 0) {
                    let highlightedText = text;
                    const regex = new RegExp(findTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    highlightedText = highlightedText.replace(regex, `<span class="highlight">${findTerm}</span>`);
                    
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <strong>üéØ Found ${matches.length} match(es) for "${findTerm}"</strong>
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>Text with highlights:</strong><br>
                            ${highlightedText}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="error">No matches found for "${findTerm}"</div>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Search error: ${error.message}</div>`;
            }
        };

        window.replaceText = function() {
            const text = document.getElementById('search-text').value;
            const findTerm = document.getElementById('find-term').value;
            const replaceTerm = document.getElementById('replace-term').value;
            const resultsDiv = document.getElementById('search-results');
            
            if (!findTerm.trim()) {
                resultsDiv.innerHTML = '<div class="error">Please enter a search term</div>';
                return;
            }
            
            try {
                const scrollBlot = new ScrollBlot(null);
                scrollBlot.append_text(text);
                
                const replacedCount = scrollBlot.replace_all(findTerm, replaceTerm, false);
                const newText = scrollBlot.text_content();
                
                // Update the textarea with the new text
                document.getElementById('search-text').value = newText;
                
                resultsDiv.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Replaced ${replacedCount} occurrence(s) of "${findTerm}" with "${replaceTerm}"</strong>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Updated text:</strong><br>
                        ${newText}
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Replace error: ${error.message}</div>`;
            }
        };

        window.runQuickTests = function() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<strong>üß™ Running tests...</strong><br>';
            
            try {
                const tests = [
                    { name: 'Selection Management', fn: test_selection_management },
                    { name: 'Find/Replace', fn: test_find_replace },
                    { name: 'Text Statistics', fn: test_text_statistics },
                    { name: 'Advanced Operations', fn: test_advanced_text_operations }
                ];
                
                let passed = 0;
                let results = '';
                
                tests.forEach(test => {
                    try {
                        const result = test.fn();
                        if (result) {
                            results += `‚úÖ ${test.name}: PASSED<br>`;
                            passed++;
                        } else {
                            results += `‚ùå ${test.name}: FAILED<br>`;
                        }
                    } catch (error) {
                        results += `üí• ${test.name}: ERROR - ${error.message}<br>`;
                    }
                });
                
                const summary = passed === tests.length ? 
                    `<div class="success"><strong>üéâ All ${tests.length} tests passed!</strong></div>` :
                    `<div class="error"><strong>‚ö†Ô∏è ${passed}/${tests.length} tests passed</strong></div>`;
                
                resultsDiv.innerHTML = summary + '<br>' + results;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Test execution error: ${error.message}</div>`;
            }
        };

        // Initialize WASM
        async function initWasm() {
            try {
                wasm = await init();
                console.log("WASM module loaded successfully");
                
                // Initialize with default statistics after WASM is loaded
                updateStatistics();
                
                // Set up auto-update for statistics
                const statsTextarea = document.getElementById('stats-text');
                if (statsTextarea) {
                    statsTextarea.addEventListener('input', updateStatistics);
                }
                
            } catch (error) {
                console.error("Failed to load WASM:", error);
                document.body.innerHTML = `<div class="error">Failed to load WASM module: ${error.message}</div>`;
            }
        }

        // Initialize when page loads
        initWasm().catch(console.error);
    </script>
</body>
</html>