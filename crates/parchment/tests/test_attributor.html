<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parchment Attributor WASM Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-element {
            margin: 10px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üéØ Parchment Attributor WASM Test</h1>
    <p>This page demonstrates all the builder pattern constructors and methods for the Attributor class.</p>

    <div id="results"></div>

    <script type="module">
        import init, { Attributor, Scope, version } from '../pkg/quillai_parchment.js';

        async function runTests() {
            const results = document.getElementById('results');
            
            function log(message, type = 'info') {
                const div = document.createElement('div');
                div.className = type;
                div.innerHTML = message;
                results.appendChild(div);
            }

            function logSection(title) {
                const section = document.createElement('div');
                section.className = 'test-section';
                section.innerHTML = `<h2>${title}</h2>`;
                results.appendChild(section);
                return section;
            }

            try {
                // Initialize WASM
                await init();
                log(`‚úÖ WASM initialized successfully. Parchment version: ${version()}`, 'success');

                // Test 1: Basic Constructor
                const section1 = logSection('üîß Test 1: Basic Constructor');
                try {
                    const linkAttr = new Attributor("link", "href");
                    section1.innerHTML += `<div class="success">‚úÖ Basic constructor works</div>`;
                    section1.innerHTML += `<div class="info">Created: ${linkAttr.attrName()} ‚Üí ${linkAttr.keyName()}</div>`;
                    section1.innerHTML += `<div class="info">Scope: ${linkAttr.scope()}</div>`;
                } catch (e) {
                    section1.innerHTML += `<div class="error">‚ùå Basic constructor failed: ${e.message}</div>`;
                }

                // Test 2: Constructor with Scope
                const section2 = logSection('üéØ Test 2: Constructor with Scope');
                try {
                    const alignAttr = Attributor.newWithScope("align", "text-align", Scope.Block);
                    section2.innerHTML += `<div class="success">‚úÖ Scope constructor works</div>`;
                    section2.innerHTML += `<div class="info">Created: ${alignAttr.attrName()} ‚Üí ${alignAttr.keyName()}</div>`;
                    section2.innerHTML += `<div class="info">Scope: ${alignAttr.scope()}</div>`;
                } catch (e) {
                    section2.innerHTML += `<div class="error">‚ùå Scope constructor failed: ${e.message}</div>`;
                }

                // Test 3: Constructor with Whitelist
                const section3 = logSection('üìù Test 3: Constructor with Whitelist');
                try {
                    const colorAttr = Attributor.newWithWhitelist("color", "color", ["red", "blue", "green", "yellow"]);
                    section3.innerHTML += `<div class="success">‚úÖ Whitelist constructor works</div>`;
                    section3.innerHTML += `<div class="info">Created: ${colorAttr.attrName()} ‚Üí ${colorAttr.keyName()}</div>`;
                    section3.innerHTML += `<div class="info">Scope: ${colorAttr.scope()}</div>`;
                } catch (e) {
                    section3.innerHTML += `<div class="error">‚ùå Whitelist constructor failed: ${e.message}</div>`;
                }

                // Test 4: Full Constructor
                const section4 = logSection('üöÄ Test 4: Full Constructor (Scope + Whitelist)');
                try {
                    const sizeAttr = Attributor.newFull("size", "font-size", Scope.Inline, ["small", "medium", "large", "x-large"]);
                    section4.innerHTML += `<div class="success">‚úÖ Full constructor works</div>`;
                    section4.innerHTML += `<div class="info">Created: ${sizeAttr.attrName()} ‚Üí ${sizeAttr.keyName()}</div>`;
                    section4.innerHTML += `<div class="info">Scope: ${sizeAttr.scope()}</div>`;
                } catch (e) {
                    section4.innerHTML += `<div class="error">‚ùå Full constructor failed: ${e.message}</div>`;
                }

                // Test 5: DOM Manipulation
                const section5 = logSection('üîß Test 5: DOM Manipulation');
                try {
                    const linkAttr = new Attributor("link", "href");
                    const testElement = document.createElement('a');
                    testElement.textContent = 'Test Link';
                    
                    // Test add method
                    const addSuccess = linkAttr.add(testElement, "https://example.com");
                    section5.innerHTML += `<div class="${addSuccess ? 'success' : 'error'}">Add method: ${addSuccess ? '‚úÖ Success' : '‚ùå Failed'}</div>`;
                    
                    // Test value method
                    const currentValue = linkAttr.value(testElement);
                    section5.innerHTML += `<div class="info">Current value: "${currentValue}"</div>`;
                    
                    // Test element attributes
                    const attributes = Attributor.keys(testElement);
                    section5.innerHTML += `<div class="info">Element attributes: [${attributes.join(', ')}]</div>`;
                    
                    // Add element to page for visual verification
                    const testDiv = document.createElement('div');
                    testDiv.className = 'test-element';
                    testDiv.innerHTML = '<strong>Test Element:</strong> ';
                    testDiv.appendChild(testElement);
                    section5.appendChild(testDiv);
                    
                    // Test remove method
                    linkAttr.remove(testElement);
                    const afterRemove = linkAttr.value(testElement);
                    section5.innerHTML += `<div class="info">After remove: "${afterRemove}"</div>`;
                    
                } catch (e) {
                    section5.innerHTML += `<div class="error">‚ùå DOM manipulation failed: ${e.message}</div>`;
                }

                // Test 6: Whitelist Validation
                const section6 = logSection('‚úÖ Test 6: Whitelist Validation');
                try {
                    const colorAttr = Attributor.newWithWhitelist("color", "style", ["red", "blue", "green"]);
                    const testDiv = document.createElement('div');
                    testDiv.textContent = 'Color Test';
                    
                    // Test valid value
                    const validResult = colorAttr.add(testDiv, "red");
                    section6.innerHTML += `<div class="${validResult ? 'success' : 'error'}">Valid value "red": ${validResult ? '‚úÖ Accepted' : '‚ùå Rejected'}</div>`;
                    
                    // Test invalid value
                    const invalidResult = colorAttr.add(testDiv, "purple");
                    section6.innerHTML += `<div class="${!invalidResult ? 'success' : 'error'}">Invalid value "purple": ${!invalidResult ? '‚úÖ Rejected' : '‚ùå Accepted'}</div>`;
                    
                    // Show current value
                    const currentColor = colorAttr.value(testDiv);
                    section6.innerHTML += `<div class="info">Current value: "${currentColor}"</div>`;
                    
                } catch (e) {
                    section6.innerHTML += `<div class="error">‚ùå Whitelist validation failed: ${e.message}</div>`;
                }

                // Test 7: Scope Values
                const section7 = logSection('üéØ Test 7: Scope Enum Values');
                try {
                    section7.innerHTML += `<div class="info">Available Scope values:</div>`;
                    section7.innerHTML += `<pre>
Scope.Type = ${Scope.Type}
Scope.Level = ${Scope.Level}
Scope.Attribute = ${Scope.Attribute}
Scope.Blot = ${Scope.Blot}
Scope.Inline = ${Scope.Inline}
Scope.Block = ${Scope.Block}
Scope.BlockBlot = ${Scope.BlockBlot}
Scope.InlineBlot = ${Scope.InlineBlot}
Scope.EmbedBlot = ${Scope.EmbedBlot}
Scope.BlockAttribute = ${Scope.BlockAttribute}
Scope.InlineAttribute = ${Scope.InlineAttribute}
Scope.Any = ${Scope.Any}
</pre>`;
                } catch (e) {
                    section7.innerHTML += `<div class="error">‚ùå Scope enumeration failed: ${e.message}</div>`;
                }

                log('üéâ All tests completed!', 'success');

            } catch (error) {
                log(`‚ùå Test suite failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        // Run tests when page loads
        runTests();
    </script>
</body>
</html>